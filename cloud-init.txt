#cloud-config
package_upgrade: true
packages:
  - apache2
  #- nginx
  #- nodejs
  #- npm
write_files:
  - owner: www-data:www-data
  - path: /etc/nginx/sites-available/default
    content: |
      server {
        listen 80;
        location / {
          proxy_pass http://localhost:3000;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection keep-alive;
          proxy_set_header Host $host;
          proxy_cache_bypass $http_upgrade;
        }
      }
  - owner: azureuser:azureuser
  - path: /home/azureuser/myapp/index.js
    content: |
      var express = require('express')
      var app = express()
      var os = require('os');
      app.get('/', function (req, res) {
        res.send('Hello World from dave2 host ' + os.hostname() + '!')
      })
      app.listen(3000, function () {
        console.log('Hello world dave app listening on port 3000!')
      })
runcmd:
  #- service nginx restart
  #- cd "/home/azureuser/myapp"
  #- npm init
  #- npm install express -y
  #- nodejs index.js
  - apt-get install software-properties-common -y
  - sudo add-apt-repository ppa:ondrej/php -y
  - sudo apt update
  - sudo apt install php7.1 libapache2-mod-php7.1 php7.1-common php7.1-mbstring php7.1-xmlrpc php7.1-soap php7.1-gd php7.1-xml php7.1-intl php7.1-mysql php7.1-cli php7.1-mcrypt php7.1-zip php7.1-curl -y
  
  - sudo sh -c 'echo "<?php phpinfo(); ?>" > /var/www/html/info.php'
